<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>WeConnect - Create Profile</title>
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"
    />
    <!-- PWA Meta Tags -->
    <meta name="theme-color" content="#696ffa" />
    <meta name="description" content="WeConnect - Create Your Profile" />
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
    <meta name="apple-mobile-web-app-title" content="WeConnect" />
    <!-- PWA Manifest -->
    <link rel="manifest" href="/manifest.json" />
    <!-- Apple Touch Icons -->
    <link rel="apple-touch-icon" href="/icons/icon-192x192.png" />
    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Open+Sans:wght@400;600&family=Roboto:wght@400;500;700&display=swap"
      rel="stylesheet"
    />
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-storage-compat.js"></script>
    <style>
      :root {
        --WeConnect-blue: #696ffa;
        --text-dark: #1A1A1A;
      }

      body {
        font-family: "Open Sans", sans-serif;
        color: var(--text-dark);
      }

      h1,
      h2,
      h3,
      h4,
      h5,
      h6,
      .heading {
        font-family: "Roboto", sans-serif;
      }

      .btn-primary {
        background-color: var(--WeConnect-blue);
      }
      .btn-primary:hover {
        background-color: #434ae8;
      }

      /* Loading overlay */
      .loading {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(255, 255, 255, 0.8);
        z-index: 9999;
        justify-content: center;
        align-items: center;
      }
      .loading.active {
        display: flex;
      }
      .spinner {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        border: 4px solid rgba(192, 0, 0, 0.1);
        border-top-color: var(--WeConnect-blue);
        animation: spin 1s linear infinite;
      }
      @keyframes spin {
        to {
          transform: rotate(360deg);
        }
      }

      /* Avatar upload styles */
      .avatar-upload {
        position: relative;
        width: 120px;
        height: 120px;
        margin: 0 auto 1.5rem;
      }
      .avatar-upload .avatar-edit {
        position: absolute;
        right: 0;
        bottom: 0;
        z-index: 1;
      }
      .avatar-upload .avatar-edit input {
        display: none;
      }
      .avatar-upload .avatar-edit label {
        display: flex;
        align-items: center;
        justify-content: center;
        width: 34px;
        height: 34px;
        border-radius: 50%;
        background: var(--WeConnect-blue);
        border: 1px solid transparent;
        color: white;
        cursor: pointer;
      }
      .avatar-upload .avatar-preview {
        width: 120px;
        height: 120px;
        border-radius: 50%;
        overflow: hidden;
        border: 4px solid #fff;
        box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
      }
      .avatar-upload .avatar-preview > div {
        width: 100%;
        height: 100%;
        background-size: cover;
        background-repeat: no-repeat;
        background-position: center;
      }

      /* Form sections */
      .form-section {
        margin-bottom: 1.5rem;
        padding-bottom: 1.5rem;
        border-bottom: 1px solid #e5e7eb;
      }
      .form-section:last-child {
        border-bottom: none;
      }
    </style>
    <script>
      // Prevent zoom on multi-touch
      document.addEventListener(
        "touchstart",
        function (event) {
          if (event.touches.length > 1) event.preventDefault();
        },
        { passive: false }
      );
      document.addEventListener(
        "touchmove",
        function (event) {
          if (event.touches.length > 1) event.preventDefault();
        },
        { passive: false }
      );
      let lastTouchEnd = 0;
      document.addEventListener(
        "touchend",
        function (event) {
          const now = Date.now();
          if (now - lastTouchEnd <= 300) event.preventDefault();
          lastTouchEnd = now;
        },
        { passive: false }
      );
    </script>
  </head>
  <body class="bg-gray-100 min-h-screen">
    <!-- Loading overlay -->
    <div id="loading" class="loading">
      <div class="spinner"></div>
    </div>

    <!-- Header -->
    <header class="bg-white shadow-sm">
      <div class="container mx-auto px-4 py-4 flex items-center">
        <img
          src="https://firebasestorage.googleapis.com/v0/b/tudds-ccd0wn.appspot.com/o/images%2Fweconnect-logo.png.png?alt=media&token=630d3910-e5c9-4c71-bfc9-698fd9411c42"
          alt="WeConnect Logo"
          class="w-10 h-10 mr-3"
        />
        <h1 class="text-xl font-bold">Complete Your Profile</h1>
      </div>
    </header>

    <!-- Main Form -->
    <main class="container mx-auto px-4 py-6 max-w-2xl">
      <div class="bg-white rounded-lg shadow-sm p-6 mb-6">
        <form id="profile-form" class="space-y-6">
          <!-- Personal Information Section (Title removed) -->
          <section class="form-section">
            <!-- Avatar Upload with prepopulated image -->
            <div class="avatar-upload">
              <div class="avatar-edit">
                <input type="file" id="avatar-upload" accept=".png, .jpg, .jpeg" />
                <label for="avatar-upload">
                  <svg
                    xmlns="http://www.w3.org/2000/svg"
                    width="16"
                    height="16"
                    viewBox="0 0 24 24"
                    fill="none"
                    stroke="currentColor"
                    stroke-width="2"
                    stroke-linecap="round"
                    stroke-linejoin="round"
                  >
                    <path d="M12 20h9" />
                    <path d="M16.5 3.5a2.121 2.121 0 0 1 3 3L7 19l-4 1 1-4L16.5 3.5z" />
                  </svg>
                </label>
              </div>
              <div class="avatar-preview">
                <div id="avatar-preview-image" style="background-image: url('assets/images/avatar.png');"></div>
              </div>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
              <label class="block">
                <span class="mb-1 text-gray-600">Full Name</span>
                <input
                  id="displayName"
                  type="text"
                  class="mt-1 block w-full border border-gray-300 rounded p-2 focus:outline-none focus:ring focus:border-blue-300"
                  placeholder="Your full name"
                  required
                />
              </label>
              <label class="block">
                <span class="mb-1 text-gray-600">Phone Number</span>
                <input
                  id="phoneNumber"
                  type="tel"
                  class="mt-1 block w-full border border-gray-300 rounded p-2 focus:outline-none focus:ring focus:border-blue-300"
                  placeholder="Your phone number"
                  required
                />
              </label>
            </div>
            <label class="block mt-4">
              <span class="mb-1 text-gray-600">Bio</span>
              <textarea
                id="bio"
                class="mt-1 block w-full border border-gray-300 rounded p-2 focus:outline-none focus:ring focus:border-blue-300"
                placeholder="Tell us about yourself"
                rows="3"
              ></textarea>
            </label>
          </section>

          <!-- Address Section -->
          <section class="form-section">
            <h2 class="text-lg font-semibold mb-4">Address</h2>
            <label class="block">
              <span class="mb-1 text-gray-600">Street Address</span>
              <input
                id="streetAddress"
                type="text"
                class="mt-1 block w-full border border-gray-300 rounded p-2 focus:outline-none focus:ring focus:border-blue-300"
                placeholder="Street address"
              />
            </label>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mt-4">
              <label class="block">
                <span class="mb-1 text-gray-600">City</span>
                <input
                  id="city"
                  type="text"
                  class="mt-1 block w-full border border-gray-300 rounded p-2 focus:outline-none focus:ring focus:border-blue-300"
                  placeholder="City"
                />
              </label>
              <label class="block">
                <span class="mb-1 text-gray-600">State/Province</span>
                <input
                  id="state"
                  type="text"
                  class="mt-1 block w-full border border-gray-300 rounded p-2 focus:outline-none focus:ring focus:border-blue-300"
                  placeholder="State/Province"
                />
              </label>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mt-4">
              <label class="block">
                <span class="mb-1 text-gray-600">Postal/ZIP Code</span>
                <input
                  id="postalCode"
                  type="text"
                  class="mt-1 block w-full border border-gray-300 rounded p-2 focus:outline-none focus:ring focus:border-blue-300"
                  placeholder="Postal/ZIP code"
                />
              </label>
              <label class="block">
                <span class="mb-1 text-gray-600">Country</span>
                <input
                  id="country"
                  type="text"
                  class="mt-1 block w-full border border-gray-300 rounded p-2 focus:outline-none focus:ring focus:border-blue-300"
                  placeholder="Country"
                />
              </label>
            </div>
          </section>

          <!-- Social Media Section -->
          <section class="form-section">
            <h2 class="text-lg font-semibold mb-4">Social Media</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
              <label class="block">
                <span class="mb-1 text-gray-600">WhatsApp</span>
                <input
                  id="whatsapp"
                  type="text"
                  class="mt-1 block w-full border border-gray-300 rounded p-2 focus:outline-none focus:ring focus:border-blue-300"
                  placeholder="WhatsApp number"
                />
              </label>
              <label class="block">
                <span class="mb-1 text-gray-600">Telegram</span>
                <input
                  id="telegram"
                  type="text"
                  class="mt-1 block w-full border border-gray-300 rounded p-2 focus:outline-none focus:ring focus:border-blue-300"
                  placeholder="Telegram username"
                />
              </label>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mt-4">
              <label class="block">
                <span class="mb-1 text-gray-600">Facebook Profile</span>
                <input
                  id="facebookProfile"
                  type="text"
                  class="mt-1 block w-full border border-gray-300 rounded p-2 focus:outline-none focus:ring focus:border-blue-300"
                  placeholder="Facebook profile URL"
                />
              </label>
              <label class="block">
                <span class="mb-1 text-gray-600">Facebook Page</span>
                <input
                  id="facebookPage"
                  type="text"
                  class="mt-1 block w-full border border-gray-300 rounded p-2 focus:outline-none focus:ring focus:border-blue-300"
                  placeholder="Facebook page URL"
                />
              </label>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mt-4">
              <label class="block">
                <span class="mb-1 text-gray-600">LinkedIn</span>
                <input
                  id="linkedin"
                  type="text"
                  class="mt-1 block w-full border border-gray-300 rounded p-2 focus:outline-none focus:ring focus:border-blue-300"
                  placeholder="LinkedIn profile URL"
                />
              </label>
              <label class="block">
                <span class="mb-1 text-gray-600">Website/Store URL</span>
                <input
                  id="website"
                  type="text"
                  class="mt-1 block w-full border border-gray-300 rounded p-2 focus:outline-none focus:ring focus:border-blue-300"
                  placeholder="Your website or store URL"
                />
              </label>
            </div>
          </section>

          <!-- MLM Specific Information -->
          <section class="form-section">
            <h2 class="text-lg font-semibold mb-4">MLM Information</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
              <label class="block">
                <span class="mb-1 text-gray-600">Sponsor ID</span>
                <input
                  id="sponsorId"
                  type="text"
                  class="mt-1 block w-full border border-gray-300 rounded p-2 focus:outline-none focus:ring focus:border-blue-300"
                  placeholder="Your sponsor's ID"
                />
              </label>
              <label class="block">
                <span class="mb-1 text-gray-600">Rank</span>
                <select
                  id="rank"
                  class="mt-1 block w-full border border-gray-300 rounded p-2 focus:outline-none focus:ring focus:border-blue-300"
                >
                  <option value="">Select your rank</option>
                  <option value="distributor">Distributor</option>
                  <option value="supervisor">Supervisor</option>
                  <option value="manager">Manager</option>
                  <option value="director">Director</option>
                  <option value="executive">Executive</option>
                </select>
              </label>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mt-4">
              <label class="block">
                <span class="mb-1 text-gray-600">Team Size</span>
                <input
                  id="teamSize"
                  type="number"
                  class="mt-1 block w-full border border-gray-300 rounded p-2 focus:outline-none focus:ring focus:border-blue-300"
                  placeholder="Number of team members"
                />
              </label>
              <label class="block">
                <span class="mb-1 text-gray-600">Preferred Payment Method</span>
                <select
                  id="paymentMethod"
                  class="mt-1 block w-full border border-gray-300 rounded p-2 focus:outline-none focus:ring focus:border-blue-300"
                >
                  <option value="">Select payment method</option>
                  <option value="bank">Bank Transfer</option>
                  <option value="paypal">PayPal</option>
                  <option value="crypto">Cryptocurrency</option>
                  <option value="mobile">Mobile Money</option>
                </select>
              </label>
            </div>
          </section>

          <button
            type="submit"
            class="w-full btn-primary text-white p-3 rounded-lg hover:opacity-90 text-lg font-medium"
          >
            Save Profile
          </button>
          <button
            type="button"
            id="skip-button"
            class="w-full border border-gray-300 text-gray-700 p-3 rounded-lg hover:bg-gray-100 text-lg font-medium mt-4"
          >
            I'll do it later
          </button>
        </form>
      </div>
    </main>

    <!-- Service Worker Registration -->
    <script>
      if ("serviceWorker" in navigator) {
        window.addEventListener("load", function () {
          navigator.serviceWorker
            .register("/service-worker.js")
            .then(
              function (registration) {
                console.log("ServiceWorker registration successful with scope: ", registration.scope);
              },
              function (err) {
                console.log("ServiceWorker registration failed: ", err);
              }
            );
        });
      }

      // Firebase configuration
      // For Firebase JS SDK v7.20.0 and later, measurementId is optional
const firebaseConfig = {
  apiKey: "AIzaSyA_XyYzO2Qi8gzBOdABUw_wxeSd51sEdk0",
  authDomain: "prime-h51r5w.firebaseapp.com",
  databaseURL: "https://prime-h51r5w-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "prime-h51r5w",
  storageBucket: "prime-h51r5w.appspot.com",
  messagingSenderId: "853174787668",
  appId: "1:853174787668:web:f6f6c73ca0c4983c7957c1"
};

      // Initialize Firebase
      firebase.initializeApp(firebaseConfig);

      // Get loading element
      const loadingElement = document.getElementById("loading");

      // Redirect if not logged in
      document.addEventListener("DOMContentLoaded", function () {
        firebase.auth().onAuthStateChanged(function (user) {
          if (!user) {
            window.location.href = "email-login.html";
          }
        });
      });

      // Handle avatar upload preview
      document.getElementById("avatar-upload").addEventListener("change", function (e) {
        const file = e.target.files[0];
        if (file) {
          const reader = new FileReader();
          reader.onload = function (e) {
            document.getElementById("avatar-preview-image").style.backgroundImage = `url(${e.target.result})`;
          };
          reader.readAsDataURL(file);
        }
      });

      // "I'll do it later" button redirect
      document.getElementById("skip-button").addEventListener("click", function () {
        window.location.href = "index.html";
      });

      // Handle form submission
      document.getElementById("profile-form").addEventListener("submit", async function (e) {
        e.preventDefault();

        // Show loading
        loadingElement.classList.add("active");

        try {
          const user = firebase.auth().currentUser;
          if (!user) throw new Error("User not authenticated");

          // Upload avatar if selected
          let avatarUrl = "";
          const avatarFile = document.getElementById("avatar-upload").files[0];
          if (avatarFile) {
            const storageRef = firebase.storage().ref();
            const avatarRef = storageRef.child(`avatars/${user.uid}`);
            await avatarRef.put(avatarFile);
            avatarUrl = await avatarRef.getDownloadURL();
          }

          // Collect form data
          const profileData = {
            displayName: document.getElementById("displayName").value,
            phoneNumber: document.getElementById("phoneNumber").value,
            bio: document.getElementById("bio").value,
            avatar: avatarUrl,
            address: {
              street: document.getElementById("streetAddress").value,
              city: document.getElementById("city").value,
              state: document.getElementById("state").value,
              postalCode: document.getElementById("postalCode").value,
              country: document.getElementById("country").value,
            },
            social: {
              whatsapp: document.getElementById("whatsapp").value,
              telegram: document.getElementById("telegram").value,
              facebookProfile: document.getElementById("facebookProfile").value,
              facebookPage: document.getElementById("facebookPage").value,
              linkedin: document.getElementById("linkedin").value,
              website: document.getElementById("website").value,
            },
            mlm: {
              sponsorId: document.getElementById("sponsorId").value,
              rank: document.getElementById("rank").value,
              teamSize: document.getElementById("teamSize").value,
              paymentMethod: document.getElementById("paymentMethod").value,
            },
            profileCompleted: true,
            updatedAt: new Date().toISOString(),
          };

          // Update user profile in Firestore
          await firebase.firestore().collection("users").doc(user.uid).update(profileData);

          // Update display name and photoURL in Firebase Auth
          await user.updateProfile({
            displayName: profileData.displayName,
            photoURL: avatarUrl || user.photoURL,
          });

          // Redirect to dashboard
          window.location.href = "index.html";
        } catch (error) {
          loadingElement.classList.remove("active");
          alert("Error: " + error.message);
          console.error("Error saving profile:", error);
        }
      });
    </script>
  </body>
</html>